<script>
  const socket = io();

  socket.on('connect', () => {
    console.log('Connected to socket.io');
  });

  // Live bot stats update - this creates/updates all bot cards
  socket.on('bots', (botsData) => {
    const grid = document.getElementById('bot-grid');
    grid.innerHTML = '';

    Object.entries(botsData).forEach(([configName, bot]) => {
      const card = document.createElement('div');
      card.className = 'bot-card';

      // Countdown display with low-time warning
      let countdownText = bot.nextShardCountdown !== null
        ? bot.nextShardCountdown + 's'
        : 'Offline';
      let countdownClass = (bot.nextShardCountdown !== null && bot.nextShardCountdown <= 10)
        ? 'countdown-low'
        : '';

      card.innerHTML = `
        <div class="bot-header">
          <div class="status-dot ${bot.online ? 'online' : 'offline'}"></div>
          <h3>${bot.minecraftUsername || configName}</h3>
        </div>
        <div class="stat-line"><span class="label">Config:</span> ${configName}</div>
        <div class="stat-line"><span class="label">Status:</span> ${bot.online ? 'ðŸŸ¢ Online' : 'ðŸ”´ Offline'}</div>
        <div class="stat-line"><span class="label">Shards:</span> ${bot.shards}</div>
        <div class="stat-line"><span class="label">Uptime:</span> ${formatUptime(bot.uptime)}</div>
        <div class="stat-line"><span class="label">Health:</span> ${bot.health}</div>
        <div class="stat-line"><span class="label">Food:</span> ${bot.food}</div>
        <div class="stat-line"><span class="label">Dimension:</span> ${bot.dimension}</div>
        <div class="stat-line"><span class="label">Position:</span> ${bot.position}</div>
        <div class="stat-line"><span class="label">Proxy:</span> ${bot.proxy}</div>
        <div class="stat-line ${countdownClass}">
          <span class="label">Next Shard:</span> ${countdownText}
        </div>

        <!-- Viewer controls - only show if bot is online -->
        ${bot.online ? `
          <div class="control-buttons" style="margin-top: 12px;">
            <button class="control-btn" 
                    style="background: ${bot.viewerRunning ? '#e74c3c' : '#2ecc71'}; color: white;"
                    onclick="${bot.viewerRunning ? `stopViewer('${configName}')` : `startViewer('${configName}')`}">
              ${bot.viewerRunning ? 'Stop Viewer' : 'Start Viewer'}
            </button>
            <button class="control-btn" 
                    style="background: ${bot.viewerRunning ? '#3498db' : '#95a5a6'}; color: white;"
                    ${bot.viewerRunning && bot.viewerPort ? '' : 'disabled'}
                    onclick="openViewer('${bot.viewerPort}')">
              Open Viewer
            </button>
          </div>
        ` : ''}

        <div class="control-buttons">
          <button class="control-btn disconnect" onclick="controlBot('${configName}', 'disconnect')">Disconnect</button>
          <button class="control-btn reconnect" onclick="controlBot('${configName}', 'reconnect')">Reconnect</button>
        </div>

        <div class="chat-per-bot">
          <input type="text" class="chat-input-small" id="chat-${configName}" placeholder="Message to ${bot.minecraftUsername || configName}" />
          <button class="control-btn send-chat" onclick="sendChat('${configName}')">Send</button>
        </div>
      `;

      grid.appendChild(card);
    });
  });

  // Auto-decrement countdowns every second
  setInterval(() => {
    const countdownElements = document.querySelectorAll('.countdown-low, .stat-line:not(.countdown-low)');
    countdownElements.forEach(el => {
      // ... your existing countdown logic ...
    });
  }, 1000);

  // Global chat display
  socket.on('chat', (data) => {
    const chatArea = document.getElementById('chat-messages');
    const msgDiv = document.createElement('div');
    msgDiv.className = 'chat-msg';
    if (data.chatUsername === 'SYSTEM') {
      msgDiv.classList.add('system');
      msgDiv.textContent = `[${data.botUsername}] ${data.message}`;
    } else {
      msgDiv.textContent = `[${data.botUsername}] ${data.chatUsername}: ${data.message}`;
    }
    chatArea.appendChild(msgDiv);
    chatArea.scrollTop = chatArea.scrollHeight;
  });

  // Global chat send
  document.getElementById('global-chat-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const input = document.getElementById('global-chat-input');
    const message = input.value.trim();
    if (!message) return;
    socket.emit('sendMessage', { message });
    input.value = '';
  });

  // Per-bot control functions
  function controlBot(botName, action) {
    socket.emit('maintenance', { action, bot: botName });
    alert(`Sent ${action} command for ${botName}`);
  }

  function sendChat(botName) {
    const input = document.getElementById(`chat-${botName}`);
    const message = input.value.trim();
    if (!message) return;
    socket.emit('sendMessage', { message, username: botName });
    input.value = '';
  }

  // NEW: Viewer control functions
  function startViewer(botName) {
    socket.emit('startViewer', { username: botName });
  }

  function stopViewer(botName) {
    socket.emit('stopViewer', { username: botName });
  }

  function openViewer(port) {
    if (port) {
      window.open(`http://localhost:${port}`, '_blank');
    }
  }

  function formatUptime(seconds) {
    if (!seconds) return 'Offline';
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    return `${h > 0 ? h + 'h ' : ''}${m}m ${s}s`;
  }
</script>