<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DonutSMP Farm Bot Dashboard</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0d1117;
      color: #c9d1d9;
      margin: 0;
      padding: 20px;
    }
    h1, h2 {
      color: #58a6ff;
    }
    #container {
      display: flex;
      gap: 30px;
      flex-wrap: wrap;
    }
    #bot-grid {
      flex: 3;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 20px;
    }
    #chat-section, #log-section {
      flex: 1;
      min-width: 340px;
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 10px;
      padding: 20px;
      height: fit-content;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
    }
    .bot-card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    .bot-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }
    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    .online { background: #00ff00; }
    .offline { background: #ff0000; }
    .stat-line {
      margin: 6px 0;
      font-size: 0.95em;
    }
    .label { color: #8b949e; }
    #chat-messages, #log-messages {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 10px;
      padding: 10px;
      background: #0d1117;
      border-radius: 6px;
      max-height: 400px;
    }
    .chat-msg, .log-entry {
      margin: 6px 0;
      padding: 8px;
      border-radius: 6px;
    }
    .chat-msg.system, .log-entry.system { background: #21262d; font-style: italic; color: #8b949e; }
    .log-entry.info { background: #21262d; }
    .log-entry.success { background: #1f4a3f; }
    .log-entry.warning { background: #4a3f1f; }
    .log-entry.error { background: #4a1f1f; color: #ff9999; }
    #chat-input-form, #log-filter {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    input, select {
      flex: 1;
      padding: 10px;
      border: 1px solid #30363d;
      border-radius: 6px;
      background: #0d1117;
      color: #c9d1d9;
    }
    button {
      padding: 10px 16px;
      background: #238636;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover { background: #2ea043; }
    button.clear { background: #6e7681; }
    button.clear:hover { background: #8b95a5; }
  </style>
</head>
<body>

<h1>DonutSMP Farm Bots - Live Dashboard</h1>

<div id="container">
  <!-- Bot stats grid -->
  <div id="bot-grid"></div>

  <!-- Chat & Logs section -->
  <div style="flex: 1; display: flex; flex-direction: column; gap: 20px;">
    <!-- Global Chat -->
    <div id="chat-section">
      <h2>Global Chat (all bots)</h2>
      <div id="chat-messages"></div>
      <form id="chat-input-form">
        <input type="text" id="chat-input" placeholder="Type message to send to all bots..." autocomplete="off" />
        <button type="submit">Send to All</button>
      </form>
    </div>

    <!-- Log Viewer -->
    <div id="log-section">
      <h2>Bot Logs Viewer</h2>
      <div id="log-filter">
        <select id="log-bot-filter">
          <option value="all">All Bots</option>
        </select>
        <button class="clear" onclick="clearLogs()">Clear Logs</button>
      </div>
      <div id="log-messages"></div>
    </div>
  </div>
</div>

<script>
  const socket = io();

  let allLogs = {}; // { botName: [entries] }

  socket.on('connect', () => {
    console.log('Connected to socket.io');
  });

  // Bot stats
  socket.on('bots', (botsData) => {
    const grid = document.getElementById('bot-grid');
    grid.innerHTML = '';

    const filterSelect = document.getElementById('log-bot-filter');
    const currentFilter = filterSelect.value;
    filterSelect.innerHTML = '<option value="all">All Bots</option>';

    Object.entries(botsData).forEach(([configName, bot]) => {
      const card = document.createElement('div');
      card.className = 'bot-card';

      card.innerHTML = `
        <div class="bot-header">
          <div class="status-dot ${bot.online ? 'online' : 'offline'}"></div>
          <h3>${bot.minecraftUsername || configName}</h3>
        </div>
        <div class="stat-line"><span class="label">Config:</span> ${configName}</div>
        <div class="stat-line"><span class="label">Status:</span> ${bot.online ? 'ðŸŸ¢ Online' : 'ðŸ”´ Offline'}</div>
        <div class="stat-line"><span class="label">Shards:</span> ${bot.shards}</div>
        <div class="stat-line"><span class="label">Uptime:</span> ${formatUptime(bot.uptime)}</div>
        <div class="stat-line"><span class="label">Health:</span> ${bot.health}</div>
        <div class="stat-line"><span class="label">Food:</span> ${bot.food}</div>
        <div class="stat-line"><span class="label">Dimension:</span> ${bot.dimension}</div>
        <div class="stat-line"><span class="label">Position:</span> ${bot.position}</div>
        <div class="stat-line"><span class="label">Proxy:</span> ${bot.proxy}</div>
      `;

      grid.appendChild(card);

      // Add to log filter
      const opt = document.createElement('option');
      opt.value = configName;
      opt.textContent = configName;
      filterSelect.appendChild(opt);
    });

    filterSelect.value = currentFilter;
  });

  // Receive individual log entries
  socket.on('bot-log', (data) => {
    const { botName, entry } = data;
    if (!allLogs[botName]) allLogs[botName] = [];
    allLogs[botName].push(entry);
    renderLogs();
  });

  // Receive full logs sync
  socket.on('all-logs', (logs) => {
    allLogs = logs;
    renderLogs();
  });

  // Render logs based on filter
  function renderLogs() {
    const filter = document.getElementById('log-bot-filter').value;
    const logArea = document.getElementById('log-messages');
    logArea.innerHTML = '';

    const botsToShow = filter === 'all' ? Object.keys(allLogs) : [filter];

    botsToShow.forEach(botName => {
      if (allLogs[botName]) {
        const header = document.createElement('h3');
        header.textContent = `Logs for ${botName}`;
        logArea.appendChild(header);

        allLogs[botName].forEach(entry => {
          const div = document.createElement('div');
          div.className = `log-entry ${entry.level}`;
          div.innerHTML = `<small>[${entry.time}]</small> ${entry.message}`;
          logArea.appendChild(div);
        });
      }
    });

    logArea.scrollTop = logArea.scrollHeight;
  }

  // Filter change
  document.getElementById('log-bot-filter').addEventListener('change', renderLogs);

  // Clear logs button
  function clearLogs() {
    allLogs = {};
    renderLogs();
    socket.emit('clear-logs');
  }

  // Global chat (your existing code)
  socket.on('chat', (data) => {
    const chatArea = document.getElementById('chat-messages');
    const msgDiv = document.createElement('div');
    msgDiv.className = 'chat-msg';
    if (data.chatUsername === 'SYSTEM') {
      msgDiv.classList.add('system');
      msgDiv.textContent = `[${data.botUsername}] ${data.message}`;
    } else {
      msgDiv.textContent = `[${data.botUsername}] ${data.chatUsername}: ${data.message}`;
    }
    chatArea.appendChild(msgDiv);
    chatArea.scrollTop = chatArea.scrollHeight;
  });

  document.getElementById('global-chat-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const input = document.getElementById('global-chat-input');
    const message = input.value.trim();
    if (!message) return;
    socket.emit('sendMessage', { message });
    input.value = '';
  });

  function formatUptime(seconds) {
    if (!seconds) return 'Offline';
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    return `${h > 0 ? h + 'h ' : ''}${m}m ${s}s`;
  }
</script>

</body>
</html>